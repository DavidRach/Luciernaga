<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Quality Control • Luciernaga</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Quality Control">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Luciernaga</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/DataVisualization.html">Data Visualization</a></li>
    <li><a class="dropdown-item" href="../articles/DimensionalityVisualization.html">Dimensionality Visualization</a></li>
    <li><a class="dropdown-item" href="../articles/QualityControl.html">Quality Control</a></li>
    <li><a class="dropdown-item" href="../articles/FluorescenceSignatures.html">Fluorescence Signatures</a></li>
    <li><a class="dropdown-item" href="../articles/FluorescentReports.html">Fluorescent Reports</a></li>
    <li><a class="dropdown-item" href="../articles/Unmixing.html">Unmixing with Luciernaga</a></li>
    <li><a class="dropdown-item" href="../articles/Wetlab.html">Wetlab Helper Functions</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DavidRach/Luciernaga/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Quality Control</h1>
                        <h4 data-toc-skip class="author">David Rach</h4>
            <address class="author_afil">
      University of Maryland,
Baltimore<br><a class="author_email" href="mailto:#"></a><a href="mailto:drach@som.umaryland.edu" class="email">drach@som.umaryland.edu</a>
      </address>
                  
            <h4 data-toc-skip class="date">1 June 2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DavidRach/Luciernaga/blob/HEAD/vignettes/QualityControl.Rmd" class="external-link"><code>vignettes/QualityControl.Rmd</code></a></small>
      <div class="d-none name"><code>QualityControl.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="instrument-qc">Instrument QC<a class="anchor" aria-label="anchor" href="#instrument-qc"></a>
</h2>
<p>This vignette covers the <code>Luciernaga</code> functions that are
involved in assessing instrumental quality control. Currently, this
section is tailored for Cytek Aurora and Northern Light (TM) spectral
cytometers that utilize SpectroFlo as their acquisition and unmixing
software. The reason for this platform bias is that these were the only
spectral cytometers at the authors home institution when designing the
package. If you would like to help us remedy this historical bias and
expand the functions to other instruments, feel free to reach out via
GitHub! :)</p>
<p>The following functions can work from either the Levy-Jennings
Tracking Reports that are generated following automated instrument QC
(exported as .csv files) or by retrieving the equivalent data stored as
keywords within an .fcs files description for a collection of .fcs files
across the timespan of interest.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidrach.github.io/Luciernaga/">Luciernaga</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">flowCore</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">flowWorkspace</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">openCyto</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RGLab/ggcyto/issues" class="external-link">ggcyto</a></span><span class="op">)</span>  </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gt.rstudio.com" class="external-link">gt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://plotly-r.com" class="external-link">plotly</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/htmltools" class="external-link">htmltools</a></span><span class="op">)</span></span></code></pre></div>
<p>Cytek Aurora instruments use fluorescent beads as part of their daily
quality control checks. These beads have complex signatures, with most
beads having peak detectors in either the Ultraviolet or Yellow-Green
Laser as can be seen below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">File_Location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"Luciernaga"</span><span class="op">)</span></span>
<span><span class="va">fcs_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">File_Location</span>, pattern<span class="op">=</span><span class="st">".fcs"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">QCBeadFile</span> <span class="op">&lt;-</span> <span class="va">fcs_files</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"After"</span>, <span class="va">fcs_files</span><span class="op">)</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">QCBead_CS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/load_cytoset_from_fcs.html" class="external-link">load_cytoset_from_fcs</a></span><span class="op">(</span><span class="va">QCBeadFile</span>, transformation <span class="op">=</span> <span class="cn">FALSE</span>, truncate_max_range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">QCBead_GS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/GatingSet-class.html" class="external-link">GatingSet</a></span><span class="op">(</span><span class="va">QCBead_CS</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Luciernaga_QC.html">Luciernaga_QC</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">QCBead_GS</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, subsets<span class="op">=</span><span class="st">"root"</span>, sample.name<span class="op">=</span><span class="st">"GUID"</span>, SignatureReturnNow <span class="op">=</span> <span class="cn">TRUE</span>, Verbose<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>              unmixingcontroltype<span class="op">=</span><span class="st">"beads"</span>, Unstained<span class="op">=</span><span class="cn">TRUE</span>, removestrings<span class="op">=</span><span class="st">".fcs"</span>, stats<span class="op">=</span><span class="st">"median"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Data</span> <span class="op">&lt;-</span> <span class="va">Data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Sample<span class="op">=</span><span class="st">"QCBeads"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">Sample</span>, .before<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">QCBeads</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_WhatsThis.html">QC_WhatsThis</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"QCBeads"</span>, data<span class="op">=</span><span class="va">Data</span>, NumberHits<span class="op">=</span><span class="fl">0</span>, returnPlots<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">QCBeads</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>Using the QC beads, the gains for instrument detectors and power to
individual lasers are adjusted to maintain a stable MFI across time.
These adjustments are available to individual users as part of a QC
report, with the underlying data available under the Levy-Jennings
tracking tab, with the option to download as a .csv file. Unfortunately,
it is not in a “tidy” data format, limiting our ability for easy
exploratory data analysis. We provide a couple functions to convert the
.csv output into a “tidy” format and visualize the data contained
within.</p>
<p>The first step is to indicate where the saved .csv file containing
the Levy-Jennings tracking data from the cytometer is stored. On a local
computer, the code to do this would look similar to the following:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FileLocation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"C:"</span>, <span class="st">"Users"</span>, <span class="st">"JohnDoe"</span>, <span class="st">"Desktop"</span>,</span>
<span>                          <span class="st">"LevyJenningsTracking.csv"</span><span class="op">)</span></span></code></pre></div>
<p>For this vignette, we will use one of these Levy-Jennings Tracking
.csvs from a 5 Laser Cytek Aurora (UV16-V16-B14-YG10-R8), that can be
found within Luciernaga’s extdata folder.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">File_Location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"Luciernaga"</span><span class="op">)</span></span>
<span><span class="va">CSV_Pattern</span> <span class="op">&lt;-</span> <span class="st">"LJTrackingData.CSV$"</span></span>
<span><span class="va">CSV_Files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path<span class="op">=</span><span class="va">File_Location</span>, pattern<span class="op">=</span><span class="va">CSV_Pattern</span>,full.names<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">CSV_Files</span></span>
<span></span>
<span><span class="va">DailyQCPattern</span> <span class="op">&lt;-</span> <span class="st">"^DailyQC"</span></span>
<span><span class="va">DailyQC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path<span class="op">=</span><span class="va">File_Location</span>, pattern<span class="op">=</span><span class="va">DailyQCPattern</span>,full.names<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">DailyQC</span></span></code></pre></div>
<div class="section level3">
<h3 id="qc_fileprep_ljtracking">QC_FilePrep_LJTracking<a class="anchor" aria-label="anchor" href="#qc_fileprep_ljtracking"></a>
</h3>
<p>Since this .CSV file is not in a tidy format, <code><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv()</a></code>
or similar functions will struggle to import correctly. Our function,
<code>QC_FilePrep()</code> reads in each row individually as text, and
then follows up on the pre-processing into a “tidy” format.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">TidyData</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_FilePrep_LJTracking.html">QC_FilePrep_LJTracking</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">CSV_Files</span>, DailyQC<span class="op">=</span><span class="va">DailyQC</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html" class="external-link">gt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">TidyData</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Individual rows are the individual QC reports, with the columns being
the different parameters. Additionally, if the individual parameter
exceeded the variance allowed resulting in a QC failure, it is recorded
under the corresponding Flag- column. With the data now “tidy”, it can
be more readily used in R to plot individual detector(s) that might be
of interest.</p>
<p>Additionally, setting <code>QC_FilePrep()</code> TrackChange to TRUE
will generate a similar output to that of the QC report showing Change
from the previous QC report which can provide additional information for
instrument monitoring.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">TidyData_Track</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_FilePrep_LJTracking.html">QC_FilePrep_LJTracking</a></span><span class="op">(</span><span class="va">CSV_Files</span>, DailyQC<span class="op">=</span><span class="va">DailyQC</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html" class="external-link">gt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">TidyData_Track</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="qc_plots">QC_Plots<a class="anchor" aria-label="anchor" href="#qc_plots"></a>
</h3>
<p>Once we have our data, we can visualize it. This can be done with
<code><a href="../reference/QC_Plots.html">QC_Plots()</a></code> for individual parameters of interest, or
iterarting over the different columns to generate all the plots. Since
there are a large number of parameters contained as individual columns,
the argument “MeasurementType” will filter the columns for matching
character values in the column names. These will be selected from the
rest and their data used for the downstream plotting.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">TidyData</span><span class="op">)</span>, <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">StorageLocation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"C:"</span>, <span class="st">"Users"</span>, <span class="st">"JohnDoe"</span>, <span class="st">"Desktop"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AvailableBroadMeasurementTypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Gain"</span>, <span class="st">"rCV"</span>, <span class="st">"Laser Delay"</span>,</span>
<span>                                    <span class="st">"Area Scaling Factor"</span><span class="op">)</span></span>
<span><span class="va">SinglePlot</span> <span class="op">&lt;-</span> <span class="st">"UV7-Gain"</span></span>
<span></span>
<span><span class="va">TheSinglePlot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_Plots.html">QC_Plots</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">TidyData</span>, MeasurementType <span class="op">=</span> <span class="va">SinglePlot</span>,</span>
<span>                          FailedFlag <span class="op">=</span> <span class="cn">TRUE</span>, returntype<span class="op">=</span><span class="st">"patchwork"</span>,</span>
<span>                          path<span class="op">=</span><span class="va">StorageLocation</span>, filename<span class="op">=</span><span class="st">"CytekAurora5L_QC"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">TheSinglePlot</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">TodaysExample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Gain"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_Plots.html">QC_Plots</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">TidyData</span>, MeasurementType <span class="op">=</span> <span class="va">TodaysExample</span>,</span>
<span>                  FailedFlag <span class="op">=</span> <span class="cn">TRUE</span>, returntype<span class="op">=</span><span class="st">"patchwork"</span>,</span>
<span>                  path<span class="op">=</span><span class="va">StorageLocation</span>, filename<span class="op">=</span><span class="st">"CytekAurora5L_QC"</span><span class="op">)</span></span>
<span><span class="va">Plots</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>Setting FailedFlag = TRUE will add a red box on the graph to showcase
the date when a particular detector failed the automated QC check by
exceeding the allowed variance set for the instrument.</p>
<p>As with most functions in Luciernaga, <code>CytekQCPlots()</code>
uses <code><a href="../reference/Utility_Patchwork.html">Utility_Patchwork()</a></code> for the .pdf generation. The
layout arrangement can be edited by providing additional arguments to
generate a desired layout for desired page size.</p>
</div>
<div class="section level3">
<h3 id="qc-retrieval">QC Retrieval<a class="anchor" aria-label="anchor" href="#qc-retrieval"></a>
</h3>
<p>In the absence of QC reports from an instrument, we can use .fcs
files acquired on the instrument over a desired period of time to
retrieve the same information. This is thanks to a lot of this data
being stored as description parameters within an .fcs file.</p>
<p>To do this, we will use .fcs files consisting of 3000 events acquired
before the DailyQC as part of monitoring. We will first identify the
files of interest, and load them into a GatingSet.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">File_Location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"Luciernaga"</span><span class="op">)</span></span>
<span><span class="va">FCS_Pattern</span> <span class="op">&lt;-</span> <span class="st">".fcs$"</span></span>
<span><span class="va">FCS_Files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">File_Location</span>, pattern <span class="op">=</span> <span class="va">FCS_Pattern</span>,</span>
<span>                        full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">QCBeads</span> <span class="op">&lt;-</span> <span class="va">FCS_Files</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"Before"</span>, <span class="va">FCS_Files</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">QCBeads</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MyCytoSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/load_cytoset_from_fcs.html" class="external-link">load_cytoset_from_fcs</a></span><span class="op">(</span><span class="va">QCBeads</span>, truncate_max_range <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                   transform <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">MyGatingSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/GatingSet-class.html" class="external-link">GatingSet</a></span><span class="op">(</span><span class="va">MyCytoSet</span><span class="op">)</span></span>
<span><span class="va">MyGatingSet</span></span></code></pre></div>
<p>Having the files now loaded into a GatingSet, we can retrieve the
information using <code>QC_Retrieval</code> function.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SingleSpecimen</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_Retrieval.html">QC_Retrieval</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">MyGatingSet</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, sample.name<span class="op">=</span><span class="st">"TUBENAME"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html" class="external-link">gt</a></span><span class="op">(</span><span class="va">SingleSpecimen</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AllSpecimens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x<span class="op">=</span><span class="va">MyGatingSet</span>, .f<span class="op">=</span><span class="va">QC_Retrieval</span>, sample.name<span class="op">=</span><span class="st">"TUBENAME"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html" class="external-link">gt</a></span><span class="op">(</span><span class="va">AllSpecimens</span><span class="op">)</span></span></code></pre></div>
<p>Once we have generated these data outputs, we can now send them to
<code>QC_Plots</code> for visualization of the instrument gain, laser
delay and area scaling factors similar to as if we had retrieved the
data from the Levy-Jennings Tracking .csv.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">YellowExample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"YG"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_Plots.html">QC_Plots</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">AllSpecimens</span>, MeasurementType <span class="op">=</span> <span class="va">YellowExample</span>,</span>
<span>                  FailedFlag <span class="op">=</span> <span class="cn">FALSE</span>, returntype<span class="op">=</span><span class="st">"patchwork"</span>,</span>
<span>                  path<span class="op">=</span><span class="va">StorageLocation</span>, filename<span class="op">=</span><span class="st">"CytekAurora5L_QC"</span>,</span>
<span>                  therows<span class="op">=</span><span class="fl">3</span>, thecolumns<span class="op">=</span><span class="fl">1</span>, width<span class="op">=</span><span class="fl">7</span>, height<span class="op">=</span><span class="fl">9</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="qc_gainmonitoring">QC_GainMonitoring<a class="anchor" aria-label="anchor" href="#qc_gainmonitoring"></a>
</h3>
<p>While <code>QC_FilePrep()</code> and <code><a href="../reference/QC_Retrieval.html">QC_Retrieval()</a></code>
provide two ways of retrieving information about the individual
detectors gains, they only tell part of the instrument story. Gains and
Lasers are dynamically changed to maintain a stable MFI over time. One
way that our cytometry core has set out to monitor this is acquiring
3000 QC beads immediately before and after running the daily QC, then
extracting and visualizing the MFI values in combination with the gain
parameters. These before/after .fcs files are processed by the
<code><a href="../reference/QC_GainMonitoring.html">QC_GainMonitoring()</a></code> function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">QCBeads</span> <span class="op">&lt;-</span> <span class="va">FCS_Files</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"Before|After"</span>, <span class="va">FCS_Files</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">QCBeads</span><span class="op">)</span></span>
<span></span>
<span><span class="va">BeforeAfter_CS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flowWorkspace/man/load_cytoset_from_fcs.html" class="external-link">load_cytoset_from_fcs</a></span><span class="op">(</span>files<span class="op">=</span><span class="va">QCBeads</span>, transform<span class="op">=</span><span class="cn">FALSE</span>, truncate_max_range <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">BeforeAfter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x<span class="op">=</span><span class="va">BeforeAfter_CS</span>, .f<span class="op">=</span><span class="va">QC_GainMonitoring</span>, sample.name <span class="op">=</span> <span class="st">"TUBENAME"</span>, stats<span class="op">=</span><span class="st">"median"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html" class="external-link">gt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">BeforeAfter</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The setup for these plots requires a couple additional arguments. The
first Metadata designates the column name under which the comparison
categories are stored (in this case, Timepoint column, with Before and
After designations). The second is we change plotType from the default
“individual” to the “comparison” category.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MFIExample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_Plots.html">QC_Plots</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">BeforeAfter</span>, MeasurementType <span class="op">=</span> <span class="va">MFIExample</span>,</span>
<span>                  Metadata <span class="op">=</span> <span class="st">"Timepoint"</span>, plotType <span class="op">=</span> <span class="st">"comparison"</span>,</span>
<span>                  FailedFlag <span class="op">=</span> <span class="cn">FALSE</span>, returntype<span class="op">=</span><span class="st">"patchwork"</span>,</span>
<span>                  path<span class="op">=</span><span class="va">StorageLocation</span>, filename<span class="op">=</span><span class="st">"CytekAurora5L_QC"</span><span class="op">)</span></span>
<span><span class="va">Plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>As we can see from the example, looking at the MFI we can see that
after daily QC, the recorded MFI across bead samples is being recorded
is similar across time, thanks in part to the changes in the individual
gain depicted above.</p>
</div>
</div>
<div class="section level2">
<h2 id="library-reference-controls">Library Reference Controls<a class="anchor" aria-label="anchor" href="#library-reference-controls"></a>
</h2>
<p>For Cytek instruments that use SpectroFlo, you are able to store
unmixing controls in the library for re-use across future experiments.
These can be exported out as .XML files, and re-imported to other
instruments. Unfortunately, after original acquisition, there is no good
way to visualize what the signature of the stored library control is.
Whether the library reference control is accurate, contaminated with
autofluorescence, or somewhere in between, we are left to parse out from
effect on full-stained samples after unmixing. The following functions
are designed to extract the signature information from the .XML files to
allow for visualization of the underlying normalized signatures. These
additionally can be plotted vs. reference signatures to compare how
closely they match.</p>
<p>For an individual user, we would first load the required libraries,
and then provide the location where the exported .XML files are stored.
An example is provided below.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidrach.github.io/Luciernaga/">Luciernaga</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://xml2.r-lib.org/" class="external-link">xml2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FolderLocation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"C:"</span>, <span class="st">"Users"</span>, <span class="st">"JohnDoe"</span>, <span class="st">"Desktop"</span>,</span>
<span>                            <span class="st">"LibraryControls5L"</span><span class="op">)</span></span>
<span><span class="va">StorageLocation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">FolderLocation</span>, <span class="st">"Visualized"</span><span class="op">)</span></span></code></pre></div>
<p>In our example today, we will be accessing the .XML files stored
within the <code>Luciernaga</code> packages extdata folder.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Folder_Location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"Luciernaga"</span><span class="op">)</span></span>
<span><span class="va">XML_Pattern</span> <span class="op">&lt;-</span> <span class="st">".XML$"</span></span>
<span><span class="va">XML_Files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">Folder_Location</span>, pattern <span class="op">=</span> <span class="va">XML_Pattern</span>,</span>
<span>                        full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">XML_Files</span></span></code></pre></div>
<div class="section level3">
<h3 id="qc_libraryparse">QC_LibraryParse<a class="anchor" aria-label="anchor" href="#qc_libraryparse"></a>
</h3>
<p><code><a href="../reference/QC_LibraryParse.html">QC_LibraryParse()</a></code> is the function that will convert the
.XML files into “tidy” data, as either plots or a dataframe. This can
either be done individually, or in combination with <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map()</a></code>
for all the files.</p>
<p>By setting the returntype to “plots”, we can return each file as a
ggplot object. In combination with <code><a href="../reference/Utility_Patchwork.html">Utility_Patchwork()</a></code> we
can generate a .pdf file or an assembled patchwork plot to our desired
dimensions.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SinglePlot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_LibraryParse.html">QC_LibraryParse</a></span><span class="op">(</span><span class="va">XML_Files</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, returntype<span class="op">=</span><span class="st">"plots"</span>, references<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ThePlots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x<span class="op">=</span><span class="va">XML_Files</span>, .f<span class="op">=</span><span class="va">QC_LibraryParse</span>, returntype<span class="op">=</span><span class="st">"plots"</span>,</span>
<span>                references<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AssembledPlot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Utility_Patchwork.html">Utility_Patchwork</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">ThePlots</span>, filename<span class="op">=</span><span class="st">"LibraryControls5L"</span>,</span>
<span>                  outfolder<span class="op">=</span><span class="cn">NULL</span>, returntype<span class="op">=</span><span class="st">"patchwork"</span>, thecolumns<span class="op">=</span><span class="fl">3</span>,</span>
<span>                  therows <span class="op">=</span> <span class="fl">3</span>, width <span class="op">=</span> <span class="fl">7</span>, height <span class="op">=</span> <span class="fl">9</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AssembledPlot</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>The Library Reference Controls featured above where acquired during a
training workshop. As you may notice, some library reference controls
appear normal, while others have some quality control issues. Profiling
the reference controls acquired on our institutions instruments, we
noticed that the location the detector gate is placed on the brightness
detector plot ties in to whether the y-axis and peak max-value is at 1.
When this is misplaced, the stored reference control has a peak greater
than 1.</p>
<p>By setting the argument “references=TRUE”, we can append the
reference signatures in red to our existing library controls.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ThePlots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x<span class="op">=</span><span class="va">XML_Files</span>, .f<span class="op">=</span><span class="va">QC_LibraryParse</span>, returntype<span class="op">=</span><span class="st">"plots"</span>,</span>
<span>                references<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AssembledPlot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Utility_Patchwork.html">Utility_Patchwork</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">ThePlots</span>, filename<span class="op">=</span><span class="st">"LibraryControls5L"</span>,</span>
<span>                  outfolder<span class="op">=</span><span class="cn">NULL</span>, returntype<span class="op">=</span><span class="st">"patchwork"</span>, thecolumns<span class="op">=</span><span class="fl">3</span>,</span>
<span>                  therows <span class="op">=</span> <span class="fl">3</span>, width <span class="op">=</span> <span class="fl">7</span>, height <span class="op">=</span> <span class="fl">9</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AssembledPlot</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>We have attempted to provide coverage for most fluorophores on all
Cytek Aurora and Northern Light Instruments. Some fluorophores not
present in the internal .csv, a mismatch in the instrument specific
fluorophore name can lead to the absence of a reference signature being
appended to the individual plot. You can investigate which of these is
the case using the <code><a href="../reference/QC_ReferenceLibrary.html">QC_ReferenceLibrary()</a></code> function.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/QC_ReferenceLibrary.html">QC_ReferenceLibrary</a></span><span class="op">(</span>FluorNameContains <span class="op">=</span> <span class="st">"FITC"</span>, NumberDetectors<span class="op">=</span><span class="fl">64</span><span class="op">)</span></span></code></pre></div>
<p>Alternatively for <code>QC_LibraryParse</code>, we can set the
returntype to “dataframe” and return in a “tidy” format.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LibraryData_Single</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_LibraryParse.html">QC_LibraryParse</a></span><span class="op">(</span><span class="va">XML_Files</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, returntype<span class="op">=</span><span class="st">"dataframe"</span>, references<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">LibraryData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x<span class="op">=</span><span class="va">XML_Files</span>, .f<span class="op">=</span><span class="va">QC_LibraryParse</span>, returntype<span class="op">=</span><span class="st">"dataframe"</span>, references<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html" class="external-link">gt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">LibraryData</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The data from the extracted signatures can then be saved as a .csv
file for future reference.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">StorageLocation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"C:"</span>, <span class="st">"Users"</span>, <span class="st">"JohnDoe"</span>, <span class="st">"Desktop"</span>,</span>
<span>                             <span class="st">"LibraryControls5L"</span><span class="op">)</span></span>
<span><span class="va">FileName</span> <span class="op">&lt;-</span> <span class="st">"ReferenceData.csv"</span></span>
<span><span class="va">StorageName</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">StorageLocation</span>, <span class="va">FileName</span><span class="op">)</span></span>
<span><span class="co"># write.csv(TheData, file=StorageName, row.names=FALSE)</span></span></code></pre></div>
<p>Please be aware, if the .XML library controls imported originated
from different instruments (consequently different laser and detector
configurations), the <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map()</a></code> followed with
<code><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows()</a></code> can occasionally fail to produce the desired
output. A workaround is to take the <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map()</a></code> outputted rows,
sort them based on number of columns, and then bind them into their own
data.frames on the basis of shared instruments laser and detector
configurations. An example of how we did this is provided below and can
be adapted for your individual situation.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Setting up example</span></span>
<span><span class="va">LibraryData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x<span class="op">=</span><span class="va">XML_Files</span>, .f<span class="op">=</span><span class="va">QC_LibraryParse</span>, returntype<span class="op">=</span><span class="st">"dataframe"</span>, references<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">LibraryData</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">LibraryData</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">LibraryData</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">LibraryData</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">LibraryData</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FirstItem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">LibraryData</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MisbehavingRows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">LibraryData</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">!=</span> <span class="va">FirstItem</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">MisbehavingRows</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">TheData_filtered</span> <span class="op">&lt;-</span> <span class="va">LibraryData</span><span class="op">[</span><span class="op">-</span><span class="va">MisbehavingRows</span><span class="op">]</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span><span class="va">TheData_filtered</span> <span class="op">&lt;-</span> <span class="va">LibraryData</span><span class="op">}</span></span>
<span></span>
<span><span class="va">TheData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">TheData_filtered</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#write.csv(TheData, file=StorageName, row.names=FALSE)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="qc_userlibraries">QC_UserLibraries<a class="anchor" aria-label="anchor" href="#qc_userlibraries"></a>
</h3>
<p>When working with XML files for multiple users, the assembled
dataframe output of <code><a href="../reference/QC_LibraryParse.html">QC_LibraryParse()</a></code> can be passed to the
<code>QC_UserLibraries</code> function, that will filter the individual
library controls by user, and send them off to
<code><a href="../reference/Utility_Patchwork.html">Utility_Patchwork()</a></code> to create a .pdf output to the desired
specifications. This can be useful tool for core staff to quickly
generate outputs for each instrument user, that can then be sent to them
to decide if they need to change any of their existing library reference
controls. The saveCSV = TRUE argument would additionally return a .csv
of the corresponding dataframe.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">TemporaryLocation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"LuciernagaTemporaryExamples"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">TemporaryLocation</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">TemporaryLocation</span><span class="op">)</span><span class="op">}</span></span>
<span></span>
<span><span class="va">TheIndividuals</span> <span class="op">&lt;-</span> <span class="va">TheData</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">Creator</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">TheIndividuals</span></span>
<span></span>
<span><span class="va">IndividualUser</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_UserLibraries.html">QC_UserLibraries</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">TheIndividuals</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, Data<span class="op">=</span><span class="va">TheData</span>,</span>
<span>                                   NameAppend<span class="op">=</span><span class="st">"_LibraryQC"</span>, outpath<span class="op">=</span><span class="va">TemporaryLocation</span>,</span>
<span>                                   references <span class="op">=</span> <span class="cn">TRUE</span>, thecolumns <span class="op">=</span> <span class="fl">3</span>, therows<span class="op">=</span><span class="fl">4</span>,</span>
<span>                                   width<span class="op">=</span><span class="fl">7</span>, height<span class="op">=</span><span class="fl">9</span>, saveCSV<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AllUsers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x<span class="op">=</span><span class="va">TheIndividuals</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, .f<span class="op">=</span><span class="va">QC_UserLibraries</span>, Data<span class="op">=</span><span class="va">TheData</span>,</span>
<span>                 NameAppend<span class="op">=</span><span class="st">"_LibraryQC"</span>, outpath<span class="op">=</span><span class="va">TemporaryLocation</span>,references <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                 thecolumns <span class="op">=</span> <span class="fl">3</span>, therows<span class="op">=</span><span class="fl">4</span>, width<span class="op">=</span><span class="fl">7</span>, height<span class="op">=</span><span class="fl">9</span>, saveCSV<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ThePDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">TemporaryLocation</span>, pattern<span class="op">=</span><span class="st">"_LibraryQC.pdf"</span><span class="op">)</span></span>
<span><span class="va">ThePDF</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="comparing-normalized-signatures">Comparing Normalized Signatures<a class="anchor" aria-label="anchor" href="#comparing-normalized-signatures"></a>
</h2>
<p>We previously highlighted the ability within
<code>QC_LibraryParse</code> to set reference=TRUE and compare our
acquired library signatures to that of a reference signature. The
following functions provide additionally functionality, extending this
to signatures derrived from additional sources (including those derrived
from .fcs files, covered extensively in Vignette 04_Fluorescent
Signatures).</p>
<p>Let’s for now continue by using a signature derrived from the Library
controls highlighted above:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LibraryData_Single</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_LibraryParse.html">QC_LibraryParse</a></span><span class="op">(</span><span class="va">XML_Files</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, returntype<span class="op">=</span><span class="st">"dataframe"</span>, references<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html" class="external-link">gt</a></span><span class="op">(</span><span class="va">LibraryData_Single</span><span class="op">)</span></span></code></pre></div>
<p>As it currently exist, there are a few additional columns that are
not required for the following functions, which we will remove.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Data</span> <span class="op">&lt;-</span> <span class="va">LibraryData_Single</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Sample</span>, <span class="op">-</span><span class="va">Creator</span>, <span class="op">-</span><span class="va">Date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>Sample<span class="op">=</span><span class="va">Fluorochrome</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html" class="external-link">gt</a></span><span class="op">(</span><span class="va">Data</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="qc_whatsthis">QC_WhatsThis<a class="anchor" aria-label="anchor" href="#qc_whatsthis"></a>
</h3>
<p>The <code><a href="../reference/QC_WhatsThis.html">QC_WhatsThis()</a></code> functions takes the above output, and
will search the reference data for fluorophores with the closest
resembling signature</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">TheFluorophore</span> <span class="op">&lt;-</span> <span class="va">Data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">Sample</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_WhatsThis.html">QC_WhatsThis</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">TheFluorophore</span>, data<span class="op">=</span><span class="va">Data</span>, NumberHits <span class="op">=</span> <span class="fl">10</span>, returnPlots<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>Setting returnPlots = TRUE, will additionally provide the plotted
signatures. In combination with <code><a href="https://rdrr.io/pkg/plotly/man/ggplotly.html" class="external-link">ggplotly()</a></code>, this can be
quite useful.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plotly/man/ggplotly.html" class="external-link">ggplotly</a></span><span class="op">(</span><span class="va">Results</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>As we can see, the acquired library signature differs from the
reference signature.</p>
</div>
<div class="section level3">
<h3 id="qc_similarfluorophores">QC_SimilarFluorophores<a class="anchor" aria-label="anchor" href="#qc_similarfluorophores"></a>
</h3>
<p>Additionally, we don’t even need to provide a signature to compare
to, if the fluorophore is present within the reference dataset, we can
compare it to the other fluorophores present and similarly visualize it
using the <code><a href="../reference/QC_SimilarFluorophores.html">QC_SimilarFluorophores()</a></code> option.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_SimilarFluorophores.html">QC_SimilarFluorophores</a></span><span class="op">(</span>TheFluorophore<span class="op">=</span><span class="st">"Spark Blue 550"</span>, NumberDetectors<span class="op">=</span><span class="fl">64</span>, NumberHits <span class="op">=</span> <span class="fl">10</span>, returnPlots<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plotly/man/ggplotly.html" class="external-link">ggplotly</a></span><span class="op">(</span><span class="va">Results</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="qc_referencelibrary">QC_ReferenceLibrary<a class="anchor" aria-label="anchor" href="#qc_referencelibrary"></a>
</h3>
<p>If there is a mismatch in how the fluorophore is named within the
reference data (or is absent), using the
<code><a href="../reference/QC_ReferenceLibrary.html">QC_ReferenceLibrary()</a></code> function would be useful in
correcting the inputed name for <code><a href="../reference/QC_SimilarFluorophores.html">QC_SimilarFluorophores()</a></code>
for the output listed above.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/QC_ReferenceLibrary.html">QC_ReferenceLibrary</a></span><span class="op">(</span>FluorNameContains <span class="op">=</span> <span class="st">"Spark"</span>, NumberDetectors<span class="op">=</span><span class="fl">64</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="qc_prospectivefluorophores">QC_ProspectiveFluorophores<a class="anchor" aria-label="anchor" href="#qc_prospectivefluorophores"></a>
</h3>
<p>And finally, we have an experimental function
<code>QC_ProspectiveFluorophores()</code> that will leverage information
about an existing panel (and the peak detectors its fluorophore
currently occupy) and contrast that to the reference library
fluorophores to find candidate fluorophores that might potentially fit
in the gaps.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">OutPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"C:"</span>, <span class="st">"Users"</span>, <span class="st">"JohnDoe"</span>, <span class="st">"Desktop"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Folder_Location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"Luciernaga"</span><span class="op">)</span></span>
<span><span class="va">ThePanelLocation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">Folder_Location</span>, pattern<span class="op">=</span><span class="st">"^Panel.csv"</span>, full.names<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ThePanel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">ThePanelLocation</span>, check.names<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Fluorophore</span><span class="op">)</span></span></code></pre></div>
<p>The arguments to provide to the function are a filepath to the
panel.csv, NumberDetectors that your instrument has (64 for a 5L
Aurora). TheCutoff corresponds to the cosine value when two fluorophores
are compared to each other, I set the cutoff at 0.9 similarity. Rank
Value comes from base R’s <code><a href="https://rdrr.io/r/base/kappa.html" class="external-link">kappa()</a></code> how error introduced will
spill over factoring across all fluorophore references in the matrix.
Rough estimate for relative complexity in our case.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ProspectiveAdditions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_ProspectiveAdditions.html">QC_ProspectiveAdditions</a></span><span class="op">(</span>path<span class="op">=</span><span class="va">ThePanelLocation</span>, NumberDetectors<span class="op">=</span><span class="fl">64</span>,</span>
<span>                                                TheCutoff<span class="op">=</span><span class="fl">0.9</span>, returnAll<span class="op">=</span><span class="cn">FALSE</span>, returnCSV<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                                                filename<span class="op">=</span><span class="st">"ProspectiveAdditions"</span>, outpath<span class="op">=</span><span class="va">OutPath</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://gt.rstudio.com/reference/gt.html" class="external-link">gt</a></span><span class="op">(</span><span class="va">ProspectiveAdditions</span><span class="op">)</span></span></code></pre></div>
<p>The results indicate potential fluorophores for Detectors not
currently occupied by our panel, with cosine overlaps of less than
TheCutoff (0.9). The RankValue is for the existing panel plus the given
fluorophore. For panel design/exploratory purposes in our own lab, we
would search for the Fluorophore name using
<code><a href="../reference/QC_SimilarFluorophores.html">QC_SimilarFluorophores()</a></code> and identify other similar
fluorophores by other commercial vendors to further investigate.</p>
<p>For example from the above list:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QC_SimilarFluorophores.html">QC_SimilarFluorophores</a></span><span class="op">(</span>TheFluorophore<span class="op">=</span><span class="st">"PE-Fire 744"</span>, NumberDetectors<span class="op">=</span><span class="fl">64</span>, NumberHits <span class="op">=</span> <span class="fl">10</span>, returnPlots<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">plotly</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plotly/man/ggplotly.html" class="external-link">ggplotly</a></span><span class="op">(</span><span class="va">Results</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="concluding-thoughts">Concluding Thoughts<a class="anchor" aria-label="anchor" href="#concluding-thoughts"></a>
</h2>
<p>We hope that this vignette walkthrough was of interest, and that you
can think of ways to implement it within your own workflow. If you have
thought on how to improve things, please reach out! This was a
particular fun section of the package to work on and I would love to
continue to improve on the existing functions in the future.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Rach.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
