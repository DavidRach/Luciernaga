---
title: "03 Quality Control"
date: "`r BiocStyle::doc_date()`"
author:
- name: David Rach
  email: drach@som.umaryland.edu
  affiliation: University of Maryland, Baltimore
package: "`r BiocStyle::pkg_ver('Luciernaga')`"
output:
  BiocStyle::html_document
bibliography: "`r file.path(system.file('extdata', package='Luciernaga'), 'refs.bib')`"
vignette: |
  %\VignetteIndexEntry{03 Quality Control}
  %\VignettePackage{Luciernaga}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This vignette covers the `Luciernaga` functions that are involved in assessing instrumental quality control. Currently, this section is tailored
for Cytek Aurora and Northern Light (TM) spectral cytometers that utilize SpectroFlo as their acquisition and unmixing software. The reason for this
platform bias is that these were the only spectral cytometers at the authors home institution when designing the package. If you would like to help us remedy this historical bias and expand the functions to other instruments, feel free to reach out via GitHub! :) 

The following functions can work from either the Levy-Jennings Tracking Reports that are generated following automated instrument QC (exported as .csv
files) or by retrieving the equivalent data stored as keywords within an .fcs files description for a collection of .fcs files across the timespan of interest. 

## Load Libraries
```{r, echo=FALSE, results = "hide", warning=FALSE}
suppressPackageStartupMessages({
library(Luciernaga)
library(flowCore)
library(flowWorkspace)
library(openCyto)
library(ggcyto)  
library(data.table)
library(dplyr)
library(purrr) 
library(stringr)
library(ggplot2)
library(gt)
library(plotly)
library(htmltools)
})
```

```{r}
library(Luciernaga)
library(flowCore)
library(flowWorkspace)

library(openCyto)
library(ggcyto)  
library(data.table)
library(dplyr)
library(purrr) 
library(stringr)
library(ggplot2)
library(gt)
library(plotly)
library(htmltools)
```


## QC_FilePrep

Cytek Aurora instruments use fluorescent beads as part of their daily quality control checks. These beads have complex signatures, with most beads having peak detectors in either the Ultraviolet or Yellow-Green Laser as can be seen below. 

```{r}
File_Location <- system.file("extdata", package = "Luciernaga")
fcs_files <- list.files(File_Location, pattern=".fcs", full.names = TRUE)
QCBeadFile <- fcs_files[grep("After", fcs_files)][[1]]

QCBead_CS <- load_cytoset_from_fcs(QCBeadFile, transformation = FALSE, truncate_max_range = FALSE)
QCBead_GS <- GatingSet(QCBead_CS)

Data <- Luciernaga_QC(x=QCBead_GS[1], subsets="root", sample.name="GUID", SignatureReturnNow = TRUE, Verbose=TRUE,
              unmixingcontroltype="beads", Unstained=TRUE, removestrings=".fcs", stats="median")

Data <- Data %>% mutate(Sample="QCBeads") %>% relocate(Sample, .before=1)

QCBeads <- QC_WhatsThis(x="QCBeads", data=Data, NumberHits=0, returnPlots=TRUE)

QCBeads[[2]]
```
Using the QC beads, the gains for instrument detectors and power to individual lasers are adjusted to maintain a stable MFI across time. These adjustments are available to individual users as part of a QC report, with the underlying data available under the Levy-Jennings tracking tab, with the option to download as a .csv file. Unfortunately, it is not in  a "tidy" data format, limiting our ability for easy exploratory data analysis. We provide a couple functions to convert the .csv output into a "tidy" format and visualize the data contained within. 

The first step is to indicate where the saved .csv file containing the Levy-Jennings tracking data from the cytometer is stored. On a local computer, the code to do this would look similar to the following:
```{r}
FileLocation <- file.path("C:", "Users", "JohnDoe", "Desktop",
                          "LevyJenningsTracking.csv")
```

For this vignette, we will use one of these Levy-Jennings Tracking .csvs from a 5 Laser Cytek Aurora (UV16-V16-B14-YG10-R8), that can be found within Luciernaga's extdata folder. 

```{r}
File_Location <- system.file("extdata", package = "Luciernaga")
CSV_Pattern <- ".CSV$"
CSV_Files <- list.files(path=File_Location, pattern=CSV_Pattern,
                        full.names=TRUE)
CSV_Files
```

Since this .CSV file is not in a tidy format, `read.csv()` or similar functions will struggle to import correctly. Our function, `QC_FilePrep()` reads in each row individually as text, and then follows up on the pre-processing into a "tidy" format. 

```{r}
TidyData <- QC_FilePrep(CSV_Files, TrackChange = FALSE)
gt(head(TidyData, 5))
```

Individual rows are the individual QC reports, with the columns being the different parameters. Additionally, if the individual parameter exceeded the variance allowed resulting in a QC failure, it is recorded under the corresponding Flag- column. With the data now "tidy", it can be more readily used in R to plot individual detector(s) that might be of interest. 

Additionally, setting `QC_FilePrep()` TrackChange to TRUE will generate a similar output to that of the QC report showing Change from the previous QC report which can provide additional information for instrument monitoring. 

```{r}
TidyData <- QC_FilePrep(CSV_Files, TrackChange = TRUE)
gt(head(TidyData, 5))
```

## QC_Plots

The next step is to take the resulting data.frame object and visualize the data contained. While this can be done for individual detectors, our function `CytekQCPlots()` will iterate over the different columns to return the plots simultaneously. Since the "tidy" QC data has ~140 QC measurements of interest, we instituted the argument "MeasurementType" to help filter for the results of interest. Behind the scenes, if the column name of the column of interest contains matching characters to your input, it will be selected and the data contained downstream sent for plotting. 

```{r}
head(colnames(TidyData), 20)
```

```{r}
StorageLocation <- file.path("C:", "Users", "JohnDoe", "Desktop")

AvailableBroadMeasurementTypes <- c("Gain", "rCV", "Laser Delay",
                                    "Area Scaling Factor")

SinglePlot <- "UV7-Gain"

TheSinglePlot <- QC_Plots(x = TidyData, MeasurementType = SinglePlot,
                          FailedFlag = TRUE, returntype="patchwork",
                          path=StorageLocation, filename="CytekAurora5L_QC")

TheSinglePlot 

TodaysExample <- c("Gain")

Plots <- QC_Plots(x = TidyData, MeasurementType = TodaysExample,
                  FailedFlag = TRUE, returntype="patchwork",
                  path=StorageLocation, filename="CytekAurora5L_QC")
Plots[1]
```

Setting FailedFlag = TRUE will add a red box on the graph to indicate the date when that particular detector failed the automated QC check. 

As with most functions in Luciernaga, `CytekQCPlots()` uses `Utility_Patchwork()` for the .pdf generation, so changes in layout arrangement when there are multiple plots can be provided as arguments.


## QC Retrieval

Sometimes we don't have access to QC reports, but we do have access to .fcs files acquired on that day. 

```{r}
File_Location <- system.file("extdata", package = "Luciernaga")
FCS_Pattern <- ".fcs$"
FCS_Files <- list.files(path = File_Location, pattern = FCS_Pattern,
                        full.names = TRUE, recursive = FALSE)
head(FCS_Files[10:30], 20)
```

```{r}
QCBeads <- FCS_Files[grep("After|Before", FCS_Files)]
head(QCBeads, 10)
```

```{r}
MyCytoSet <- load_cytoset_from_fcs(QCBeads, truncate_max_range = FALSE,
                                   transform = FALSE)
MyCytoSet
MyGatingSet <- GatingSet(MyCytoSet)
MyGatingSet
```

```{r}
SingleSpecimen <- QC_Retrieval(x=MyGatingSet[[1]], sample.name="TUBENAME")

SingleSpecimen

AllSpecimens <- map(.x=MyGatingSet, .f=QC_Retrieval, sample.name="TUBENAME") %>%
  bind_rows()
```

## QC_LibraryParse

Cytek allows acquisition of unmixing controls that are stored in the library and can be re-used across experiments. These can be exported as .XML files and reimported to other instruments. Unfortunately, after acquisition there is no way to visualize the library unmixing controls normalized signature. So whether the library reference control is accurate, contaminated with autofluorescence, there is no way of knowing. These following functions will convert the .XML single color unmixing control files present in a reference folder into a data.frame, that can then be plotted as normalized line plots. We additionally provide the option to plot reference signatures when the fluorophore names match. 

```{r, echo=FALSE, results = "hide", warning=FALSE}
suppressPackageStartupMessages({
library(Luciernaga)
library(xml2)
library(tidyr)
library(purrr)
library(dplyr)
library(ggplot2)
})
```

```{r}
library(Luciernaga)
library(xml2)
library(tidyr)
library(purrr)
library(dplyr)
library(ggplot2)
```

```{r}
FolderLocation <- file.path("C:", "Users", "JohnDoe", "Desktop",
                            "LibraryControls5L")
StorageLocation <- file.path(FolderLocation, "Visualized")
```

```{r}
Folder_Location <- system.file("extdata", package = "Luciernaga")
XML_Pattern <- ".XML$"
XML_Files <- list.files(path = Folder_Location, pattern = XML_Pattern,
                        full.names = TRUE, recursive = FALSE)
XML_Files
```

Specifying returntype = "plots" will return ggplot objects of the library reference signatures. We can use `Utility_Patchwork()` to generate a .pdf file or a assembled patchwork plot with our desired dimensions. 

```{r}
QC_LibraryParse(XML_Files[2], returntype="plots", references=FALSE)

ThePlots <- map(.x=XML_Files, .f=QC_LibraryParse, returntype="plots",
                references=FALSE)

Utility_Patchwork(x=ThePlots, filename="LibraryControls5L",
                  outfolder=NULL, returntype="patchwork", thecolumns=3,
                  therows = 3, width = 7, height = 9)
```
As you may notice, while some library reference controls closely match the reference signature, others have some quality control issues. In profiling reference controls at our own institution, we also found that the location of the detector gate placed on the brightness detector ties in to whether the y-axis and peak max-value is at 1. When this is misset, the stored reference control has a peak greater than 1. 

By specifying references = TRUE we can plot the reference signatures. We have attempted to provide coverage of most fluorophores for all Cytek Aurora and Northern Light instruments. Some fluorophores are not present in the internal reference .csv, which can result in fail to plot. Other times a mismatch in the instrument specific fluorophore name can be the cause. 

```{r}
ThePlots <- map(.x=XML_Files, .f=QC_LibraryParse, returntype="plots",
                references=TRUE)

Utility_Patchwork(x=ThePlots, filename="LibraryControls5L",
                  outfolder=NULL, returntype="patchwork", thecolumns=3,
                  therows = 3, width = 7, height = 9)
```
Instead of a plot, you can also return a data.frame object that can subsequently be saved as a .csv file for future reference. 

```{r}
TheData <- map(.x=XML_Files, .f=QC_LibraryParse, returntype="dataframe") %>%
  bind_rows()
TheData

StorageLocation <- file.path("C:", "Users", "JohnDoe", "Desktop",
                             "LibraryControls5L")
FileName <- "ReferenceData.csv"
StorageName <- file.path(StorageLocation, FileName)
# write.csv(TheData, file=StorageName, row.names=FALSE)
```

Be aware, if library controls from different instruments with different laser (and detector configuration) are present, `bind_rows()` will fail. The output data.frame rows will need to first be sorted to make sure every row has the same number of columns, and then `bind_rows()` can be used to form a data.frame for each instrument laser*detector configuration. We provide code for reference below that you can adapt for your own individual purposes:

```{r, eval = FALSE, echo=FALSE}
FirstItem <- ncol(TheData)

MisbehavingRows <- which(sapply(TheData, function(x) ncol(x) != FirstItem))

if(length(MisbehavingRows) != 0) {
  TheData_filtered <- TheData[-MisbehavingRows]
  } else {TheData_filtered <- TheData}
TheData <- bind_rows(TheData_filtered)

#write.csv(TheData, file=StorageName, row.names=FALSE)
```


```{r sessionInfo, echo = FALSE}
sessionInfo()
```



