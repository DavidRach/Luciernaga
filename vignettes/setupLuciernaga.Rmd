---
title: "Luciernaga Setup"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{setupLuciernaga}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Before starting, make sure the following libraries are installed. Then load packages into your library. packages into your library.

```{r setup}
packages_needed = c("flowCore", "flowWorkspace", "openCyto", "ggcyto", "dplyr",
    "purrr", "stringr", "tidyr", "data.table", "patchwork", "zoo", "reshape2",
    "lsa", "viridis")
x <- packages_needed

Loaded <- lapply(x, FUN = function(X) {do.call("require", list(X))})

library(Luciernaga)
```

You will then need to specify where your fcs files are stored, and to what folders you want the outputs saved. Here is an example:

```{r}
########################
# Experimental Changes #
########################

CurrentExperiment <- "ILT_15"

# Set the file path to the folder containing your .fcs files:
path <- file.path("E:", "LuciernagaDatabase", "LuciernagaInputs", "ILT_15",
    fsep = "/")

# Set the file path to where you want to save the gating plot Luciernaga
# outputs.
OutPath <- file.path("E:", "LuciernagaDatabase", "LuciernagaFiles", "ILT_15",
    "VisualCheck", fsep = "/")

# Set the file path to where you want to save the .fcs Luciernaga outputs.
MainOutPath <- "E:/LuciernagaDatabase/LuciernagaFiles/ILT_15/"

######################
# Same for Every Run #
######################
# Set the file path to the folder containing the .csv file with the openCyto
# gating scheme:
CSVpath <- file.path("E:", "LuciernagaDatabase", "LuciernagaInputs", fsep = "/")

# Set the file name for the openCyto Gatings:
gtFile <- fread(file.path(path = CSVpath, pattern = "SingleColorGating.csv"))

# Set the file name for the AF overlapping Channels:
AFOverlap <- fread(file.path(path = CSVpath,
    pattern = "SingleColorDetectors.csv"))

# Return Folder
ReturnFolder <- "E:/LuciernagaDatabase/LuciernagaFiles/"

###################
# Time to Proceed #
###################

# Identify .fcs files (.+ is an 'AND' proxy)
pattern1 = ".fcs$"
fcs_files1 <- list.files(path = path, pattern = pattern1, full.names = TRUE,
    recursive = TRUE)
files <- fcs_files1
# files <- fcs_files1[16:19] #subset files

if (length(files) < 1) {
    print("No Files Found")
} else {
    print(files)
}

```

Now it's time to load the fcs files and gate with the specified gates.

```{r}
# FCS to Gating Set
cs <- load_cytoset_from_fcs(files, truncate_max_range = FALSE, transform = FALSE)
gs <- GatingSet(cs)

# For troubleshooting #keyword(cs[[1]]) #exprs(cs[[1]]) #gs_get_leaf_nodes(gs)

# Applying the Gating to the Gating Set gtFile <- fread(file.path(path =
# CSVpath, pattern = 'SingleColorGating.csv'))
gating <- gatingTemplate(gtFile)
gt_gating(gating, gs)
```

We can then plot and see that the gating was appropiate

```{r}
Here <- map(gs, SingleColorPlots, sample.name = "GUID",
        experiment.name = "GROUPNAME", subsets = "root", bins = 270,
        clearance = 0.2, outpath = OutPath, sourcelocation = "GeneralGating.R")
```

```{r}
# files
TheUnstained <- c(1:19)
TheBV510 <- c(37)
TheBUV737 <- c(43)
ThePacBlue <- c(44)
TheZombie <- c(51:52)

LengthFiles <- c(1:length(files))

Vectors <- c(TheUnstained, TheBV510, TheBUV737, ThePacBlue, TheZombie)
Vectors <- sort(Vectors)

TheSingleColors <- setdiff(LengthFiles, Vectors)
breaks <- c(0, diff(TheSingleColors) != 1, 0)
SingleColorSublists <- split(TheSingleColors, cumsum(breaks))

ThePacBlueZombies <- c(TheZombie, ThePacBlue)
ThePacBlueZombies <- sort(ThePacBlueZombies)
breaks <- c(0, diff(ThePacBlueZombies) != 1, 0)
ThePacBlueZombies <- split(ThePacBlueZombies, cumsum(breaks))
```

```{r}
#ThePacBlueZombies

Output <- map(gs[c(44, 51:52)], Utility_MonocyteZombies, sample.name = "GUID",
    bins = 270)

#Unstained
Output <- map(gs[1], Utility_MonocyteZombies, sample.name = "GUID",
    bins = 270)
```

```{r}
### Not enough in ILT_15 ####


#### BUV737 ####
#TheBUV737

tryCatch({
    BUV737 <- map(gs[43], Utility_SingleColorQC, subsets = "lymph",
        sample.name = "GUID", group.name = "GROUPNAME", experiment = NULL,
        experiment.name = "$DATE", stats = "median", Kept = "Normalized",
        external = NULL, sourcelocation = "Genesis.R", outpath = MainOutPath,
        artificial = FALSE, fcsexport = TRUE, mainAF = "V7-A",
        AFOverlap = AFOverlap, Beads = FALSE, Brightness = TRUE,
        Unstained = FALSE) %>%
        bind_rows()
})
```

```{r}
#### Single Colors ####
#SingleColorSublists


    SingleColors <- map(gs[c(20:36, 38:42, 45:50)], Utility_SingleColorQC,
        subsets = "lymph", sample.name = "GUID", group.name = "GROUPNAME",
        experiment = NULL, experiment.name = "$DATE", stats = "median",
        Kept = "Normalized", external = NULL, sourcelocation = "Genesis.R",
        outpath = MainOutPath, artificial = FALSE, fcsexport = TRUE,
        mainAF = "V7-A", AFOverlap = AFOverlap, Beads = FALSE,
        Brightness = TRUE, Unstained = FALSE) %>%
        bind_rows()


#### Unstained ####
#TheUnstained


    Unstained <- map(gs[c(1:19)], Utility_SingleColorQC, subsets = "lymph",
        sample.name = "GUID", group.name = "GROUPNAME", experiment = NULL,
        experiment.name = "$DATE", stats = "median", Kept = "Normalized",
        external = NULL, sourcelocation = "Genesis.R", outpath = MainOutPath,
        artificial = FALSE, fcsexport = TRUE, mainAF = "V7-A",
        AFOverlap = AFOverlap, Beads = FALSE, Brightness = TRUE, 
        Unstained = FALSE) %>%
        bind_rows()


### Unstained Backgrounds #
#TheUnstained[[1]]


    ExternalSampling <- map(gs[1], Utility_SingleColorQC, subsets = "lymph",
        sample.name = "GUID", group.name = "GROUPNAME", experiment = NULL,
        experiment.name = "$DATE", stats = "median", Kept = "Normalized",
        external = NULL, sourcelocation = "Genesis.R", outpath = MainOutPath,
        artificial = FALSE, fcsexport = TRUE, mainAF = "V7-A",
        AFOverlap = AFOverlap, Beads = FALSE, Brightness = TRUE, 
        Unstained = FALSE) %>%
        bind_rows()

ExternalName <- ExternalSampling %>%
    select(c(-1:-4, -6)) %>%
    slice(1) %>%
    pull(Cluster)
RegularUnstained <- ExternalSampling %>%
    select(c(-1:-4, -6)) %>%
    slice(1) %>%
    select(-Cluster)

#TheUnstained[[1]]

    ExternalSampling <- map(gs[1], Utility_SingleColorQC,
        subsets = "Monocytes", sample.name = "GUID", group.name = "GROUPNAME",
        experiment = NULL, experiment.name = "$DATE", stats = "median",
        Kept = "Normalized", external = NULL, sourcelocation = "Genesis.R",
        outpath = MainOutPath, artificial = FALSE, fcsexport = TRUE,
        mainAF = "V7-A", AFOverlap = AFOverlap, Beads = FALSE,
        Brightness = TRUE, Unstained = FALSE) %>%
        bind_rows()

ExternalName <- ExternalSampling %>%
    select(c(-1:-4, -6)) %>%
    slice(1) %>%
    pull(Cluster)
MonocytesUnstained <- ExternalSampling %>%
    select(c(-1:-4, -6)) %>%
    slice(1) %>%
    select(-Cluster)

#TheUnstained[[1]]

    ExternalSampling <- map(gs[1], Utility_SingleColorQC, subsets = "Dead",
        sample.name = "GUID", group.name = "GROUPNAME", experiment = NULL,
        experiment.name = "$DATE", stats = "median", Kept = "Normalized",
        external = NULL, sourcelocation = "Genesis.R", outpath = MainOutPath,
        artificial = FALSE, fcsexport = TRUE, mainAF = "V7-A",
        AFOverlap = AFOverlap, Beads = FALSE, Brightness = TRUE, 
        Unstained = FALSE) %>%
        bind_rows()

ExternalName <- ExternalSampling %>%
    select(c(-1:-4, -6)) %>%
    slice(1) %>%
    pull(Cluster)
DeadUnstained <- ExternalSampling %>%
    select(c(-1:-4, -6)) %>%
    slice(1) %>%
    select(-Cluster)

#### Single Colors with External ####
#ThePacBlue


    PacBlue <- map(gs[44], Utility_SingleColorQC, subsets = "Monocytes",
        sample.name = "GUID", group.name = "GROUPNAME", experiment = NULL,
        experiment.name = "$DATE", stats = "median", Kept = "Normalized",
        external = MonocytesUnstained, sourcelocation = "Genesis.R",
        outpath = MainOutPath, artificial = FALSE, fcsexport = TRUE,
        mainAF = "V7-A", AFOverlap = AFOverlap, Beads = FALSE,
        Brightness = TRUE, Unstained = FALSE) %>%
        bind_rows()


#TheZombie

    Zombie <- map(gs[51:52], Utility_SingleColorQC, subsets = "Dead",
        sample.name = "GUID", group.name = "GROUPNAME", experiment = NULL,
        experiment.name = "$DATE", stats = "median", Kept = "Normalized",
        external = DeadUnstained, sourcelocation = "Genesis.R",
        outpath = MainOutPath, artificial = FALSE, fcsexport = TRUE,
        mainAF = "V7-A", AFOverlap = AFOverlap, Beads = FALSE,
        Brightness = TRUE, Unstained = FALSE) %>%
        bind_rows()


#TheBV510

    BV510 <- map(gs[37], Utility_SingleColorQC, subsets = "lymph",
        sample.name = "GUID", group.name = "GROUPNAME", experiment = NULL,
        experiment.name = "$DATE", stats = "median", Kept = "Normalized",
        external = RegularUnstained, sourcelocation = "Genesis.R",
        outpath = MainOutPath, artificial = FALSE, fcsexport = TRUE,
        mainAF = "V7-A", AFOverlap = AFOverlap, Beads = FALSE,
        Brightness = TRUE, Unstained = FALSE) %>%
        bind_rows()


#Combining Outputs
if(exists("BUV737")){TestTryThis <- rbind(SingleColors, Unstained, BV510, 
        BUV737, PacBlue, Zombie)
        } else {TestTryThis <- rbind(SingleColors, Unstained, BV510, 
        PacBlue, Zombie)}
```

```{r}
BrightPattern = "^RelativeBrightness"
BrightFiles <- list.files(path = MainOutPath, pattern = BrightPattern, full.names = TRUE,
    recursive = TRUE)

LuciernagaFiler <- function(x){
  x <- x
  result <- sub(".*/", "", x)
  sample <- gsub(BrightPattern, "", gsub(".csv$", "", result))
  Data <- read.csv(x, check.names = FALSE)
  Data <- cbind(sample, Data)  
  return(Data)
}

Condensing <- map(BrightFiles, LuciernagaFiler) %>% bind_rows()
Condensing <- Condensing %>% select(1:12)

#Condensing$sample
Condensing$sample <- gsub("DR", "", Condensing$sample)
Condensing$sample <- gsub("Dump", "", Condensing$sample)

TestTryThis$sample <- gsub("DR_", "", gsub(" ", "", gsub("-", "", TestTryThis$sample)))
TestTryThis$sample <- gsub("Dump_", "", TestTryThis$sample)

#Condensing$Cluster
TestTryThis$Cluster <- gsub("-$", "", TestTryThis$Cluster)

Curated <- left_join(TestTryThis, Condensing, by = c("sample", "Cluster"))
Curated <- Curated %>% relocate(c(Brightness:Detector3Raw), .after = Count)
Curated <- Curated %>%
    group_by(sample, group) %>%
    mutate(Ratio = Count/sum(Count)) %>%
    ungroup() %>%
    filter(Ratio > 0.01) %>%
    relocate(Ratio, .after = Count)

 CuratedPath <- paste0(ReturnFolder, CurrentExperiment, '.csv')
 write.csv(Curated, CuratedPath, row.names = FALSE)
```

```{r}
#Combining Outputs
if(exists("BUV737")){TestTryThis <- rbind(SingleColors, Unstained, BV510, 
        BUV737, PacBlue, Zombie)
        } else {TestTryThis <- rbind(SingleColors, Unstained, BV510, 
        PacBlue, Zombie)}

Curated <- TestTryThis %>% group_by(sample, group) %>% mutate(Ratio = Count/sum(Count)) %>% ungroup() %>% filter(Ratio > 0.01) %>% relocate(Ratio, .after = Count)

TheData <- Curated

TheData$sample <- gsub("DR_", "", TheData$sample)
TheData$sample <- gsub("-", "", gsub(".", "", fixed = TRUE, gsub("_", "", TheData$sample)))
TheData$sample <- sub(" ", "_", TheData$sample)
TheData$sample <- gsub(" ", "", TheData$sample)
TheData$sample <- gsub("Unstained", "_Unstained", TheData$sample)
TheData$sample <- gsub("^_Unstained$", "Unstained_Unstained", TheData$sample)
TheData$sample <- sub("^\\d+", "", TheData$sample)

TheData$group <- gsub("Reference Group", "", TheData$group)

TheData <- TheData %>% unite(sample, c(group, sample), sep = "")
TheData$sample <- gsub("ND006_13INF", "INF", TheData$sample)
TheData$sample <- gsub("ND050_13INF", "INF", TheData$sample)

    Utility_Luciernaga(LuciernagaData = TheData, LuciernagaVariables = "sample",
        LuciernagaClusters = "Cluster", filename = CurrentExperiment,
        outfolder = ReturnFolder)

```
