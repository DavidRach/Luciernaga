---
title: "Quality Control"
author:
- name: David Rach
  affiliation: University of Maryland, Baltimore
  email: drach@som.umaryland.edu
package: Luciernaga
output:
  BiocStyle::html_document
abstract: |
  How to set up Luciernaga
vignette: |
  %\VignetteIndexEntry{Getting Started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This vignette addresses some of the instrumental quality control functions implemented by Luciernaga. Due to the only Spectral Cytometers at the authors institution being are Cytek (TM) Aurora and Northern Light cytometers that utilize the SpectroFlo software for acquisition and unmixing, there is a heavy bias towards them in terms of the functions presented in this vignette. If you would like to address this by contributing your own function that expands the repertoire of manufacturers and instruments covered by this vignette, please reach out via GitHub with a pull request. 

## Load Libraries
```{r, echo=FALSE, results = "hide", warning=FALSE}
suppressPackageStartupMessages({
library(Luciernaga)
library(flowCore)
library(flowWorkspace)
library(openCyto)
library(ggcyto)  
library(data.table)
library(dplyr)
library(purrr) 
library(stringr)
library(ggplot2)
library(gt)
library(plotly)
library(htmltools)
})
```

```{r Load Libraries}
library(Luciernaga)
library(flowCore)
library(flowWorkspace)
library(openCyto)
library(ggcyto)  
library(data.table)
library(dplyr)
library(purrr) 
library(stringr)
library(ggplot2)
library(gt)
library(plotly)
library(htmltools)
```


## CytekQCFilePrep

Cytek Aurora instruments use fluorescent beads as part of their daily quality control checks. These result in the production of a QC report visible to the user, with the underlying data stored under the Levy-Jennings tracking tab. When downloaded, this returns a .csv file. However, it is not in a "tidy" data format, which limits it's direct usefulness for exploratory data analysis via functional programming in R. We provide several functions to convert this output into a "tidy" format, and then to visualize the data contained. 

The first step is to indicate where the saved .csv file containing the Levy-Jennings tracking data from the cytometer is stored. On a local computer, the code to do this would resemble the following:
```{r}
FileLocation <- file.path("C:", "Users", "JohnDoe", "Desktop", "LevyJenningsTracking.csv")
```

For this vignette, we will be accessing a .csv folder that can be found in Luciernaga's extdata folder containing three months of Levy-Jennings Tracking data for a 5 Laser Cytek Aurora (UV16-V16-B14-YG10-R8) for our example. 

```{r Access Package Data}
File_Location <- system.file("extdata", package = "Luciernaga")
CSV_Pattern <- ".CSV$"
CSV_Files <- list.files(path=File_Location, pattern=CSV_Pattern, full.names=TRUE)
CSV_Files
```

Since this .CSV file is not is not in a tidy format, `read.csv()` will have issues when attempting to import directly. Instead, `CytekQCPlots()` will attempt to read in each row individually as text and from there pre-process it. 

```{r}
TidyData <- CytekQCFilePrep(CSV_Files, TrackChange = FALSE)
gt(head(TidyData))
```

Once the data has been "tidyed", it can be used within R for plotting of any individual detector(s) that might be of interest. The Track Change option to `CytekQCFilePrep()` will calculate the difference between days which can additionally be of interest for monitoring the instrument. 

## CytekQCPlots

The next step is to take the resulting data.frame object and visualize the data contained. While this can be done for individual detectors, our function `CytekQCPlots()` will iterate over the different columns to return the plots simultaneously. Since the "tidy" QC data has ~140 QC measurements of interest, we instituted the argument "MeasurementType" to help filter for the results of interest. Behind the scenes, if the column name of the column of interest contains matching characters to your input, it will be selected and the data contained downstream sent for plotting. 

```{r}
head(colnames(TidyData), 20)
```

```{r}
StorageLocation <- file.path("C:", "Users", "JohnDoe", "Desktop")

AvailableBroadMeasurementTypes <- c("Gain", "rCV", "Laser Delay", "Area Scaling Factor")

SinglePlot <- "UV7-Gain"

TheSinglePlot <- CytekQCPlots(x = TidyData, MeasurementType = SinglePlot, FailedFlag = TRUE, pdf=FALSE, path=StorageLocation, filename="CytekAurora5L_QC")
TheSinglePlot 

TodaysExample <- c("Gain")

Plots <- CytekQCPlots(x = TidyData, MeasurementType = TodaysExample, FailedFlag = TRUE, pdf=FALSE, path=StorageLocation, filename="CytekAurora5L_QC")
Plots[1]
```

Setting FailedFlag = TRUE will add a red box on the graph to indicate the date when that particular detector failed the automated QC check. 

As with most functions in Luciernaga, `CytekQCPlots()` uses `Utility_Patchwork()` for the .pdf generation, so changes in layout arrangement when there are multiple plots can be provided as arguments.


## QC Retrieval

Sometimes we don't have access to QC reports, but we do have access to .fcs files acquired on that day. 

```{r Access Package Data}
File_Location <- system.file("extdata", package = "Luciernaga")
FCS_Pattern <- ".fcs$"
FCS_Files <- list.files(path = File_Location, pattern = FCS_Pattern, full.names = TRUE, recursive = FALSE)
FCS_Files
```

```{r Selecting Desired Files}
SubsetFCSFiles <- FCS_Files[c(1:2, 6)]
SubsetFCSFiles
```

```{r}
MyCytoSet <- load_cytoset_from_fcs(SubsetFCSFiles, truncate_max_range = FALSE, transform = FALSE)
MyCytoSet
MyGatingSet <- GatingSet(MyCytoSet)
MyGatingSet
```

```{r}
#QCRetrieval(x=MyGatingSet[[1]], sample.name = "GROUPNAME")
#?Luciernaga::QCRetrieval
```

## Cytek Library QC Signatures

Cytek allows acquisition of unmixing controls that are stored in the library and can be re-used across experiments. These can be exported as .XML files and reimported to other instruments. Unfortunately, after acquisition there is no way to visualize the library unmixing controls normalized signature. So whether the library reference control is accurate, contaminated with autofluorescence, there is no way of knowing. These following functions will convert the .XML single color unmixing control files present in a reference folder into a data.frame, that can then be plotted as normalized line plots. We additionally provide the option to plot reference signatures when the fluorophore names match. 

```{r, echo=FALSE, results = "hide", warning=FALSE}
suppressPackageStartupMessages({
library(Luciernaga)
library(xml2)
library(tidyr)
library(purrr)
library(dplyr)
library(ggplot2)
})
```

```{r Load Libraries}
library(Luciernaga)
library(xml2)
library(tidyr)
library(purrr)
library(dplyr)
library(ggplot2)
```

```{r}
FolderLocation <- file.path("C:", "Users", "JohnDoe", "Desktop", "LibraryControls5L")
StorageLocation <- file.path(FolderLocation, "Visualized")
```

```{r}
Folder_Location <- system.file("extdata", package = "Luciernaga")
XML_Pattern <- ".XML$"
XML_Files <- list.files(path = Folder_Location, pattern = XML_Pattern, full.names = TRUE, recursive = FALSE)
XML_Files
```

```{r}
x <- XML_Files[1]

```

```{r sessionInfo, echo = FALSE}
sessionInfo()
```



